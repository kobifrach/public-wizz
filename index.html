<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='52' font-size='52'%3E%E2%9C%88%EF%B8%8F%3C/text%3E%3C/svg%3E">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Search</title>
    <style>
        html {
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        form {
            width: 100%;
            max-width: 420px;
            margin: 12px auto;
            padding: 10px 6px 16px 6px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            font-size: 15px;
        }

        input[type="email"],
        input[type="password"],
        select,
        input[list] {
            width: 100%;
            padding: 10px 8px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            background: #fafbfc;
        }

        input[list] {
            min-width: 0;
        }

        fieldset {
            border: none;
            margin-bottom: 10px;
            padding: 0;
        }

        legend {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        button {
            display: inline-block;
            padding: 10px 0;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-bottom: 8px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button[type="button"] {
            margin-top: 4px;
            width: auto;
            padding: 7px 16px;
            font-size: 15px;
        }

        div {
            margin-bottom: 10px;
        }

        .multi-select-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .row {
            background-color: #f9f9f9;
            padding: 7px 6px 7px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 7px;
            position: relative;
            min-height: 36px;
        }

        .remove-row-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 8px 10px !important;
            font-size: 18px;
            font-weight: 900;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            line-height: 1;
            z-index: 2;
            height: 34px;
        }

        .remove-row-btn:hover {
            background: #c0392b;
        }

        #add-row-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .divider {
            height: 1px;
            background-color: #ddd;
            margin: 12px 0;
        }

        #dates-checkboxes label {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 2px;
            font-weight: normal;
            font-size: 14px;
        }

        #select-all-dates {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 14px;
            padding: 6px 12px;
        }

        [type="submit"] {
            width: 100%;
            margin: 0;
            font-size: 18px;
            padding: 12px 0;
        }

        h1 {
            font-size: 1.5em;
            margin: 18px 0 10px 0;
            letter-spacing: 1px;
        }

        @media (min-width: 600px) {
            form {
                max-width: 480px;
                padding: 18px 24px 24px 24px;
            }

            h1 {
                font-size: 2.1em;
                margin: 32px 0 12px 0;
            }

            input[type="email"],
            input[type="password"],
            select,
            input[list] {
                font-size: 15px;
                padding: 8px 10px;
            }

            button {
                font-size: 15px;
                padding: 10px 0;
            }

            [type="submit"] {
                font-size: 17px;
                padding: 13px 0;
            }
        }
    </style>
</head>

<body>
    <h1 style="text-align:center; font-size:2.1em; margin:32px 0 12px 0; letter-spacing:1px;">✈️ Wizz Flights Search ✈️
    </h1>
    <form id="flight-search-form">
        <!-- User Credentials -->
        <label for="username">Username (Email):</label>
        <input type="email" id="username" name="username" required>

        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>

        <!-- Connection Mode -->
        <fieldset>
            <legend>Connection Mode:</legend>
            <label>
                <input type="radio" name="connection" value="none" checked> None
            </label>
            <label>
                <input type="radio" name="connection" value="with"> With
            </label>
        </fieldset>

        <!-- Dynamic Content -->
        <div id="dynamic-content"></div>

        <div class="divider"></div>

        <!-- Date Selector -->
        <label for="dates">Select Dates:</label>
        <div id="dates-checkboxes"></div>
        <button type="button" id="select-all-dates">Select All</button>

        <!-- Start Button -->
        <div style="text-align: center; margin: 24px 0;">
            <button type="submit">Start</button>
        </div>
    </form>

    <script>
        let pairs = {};

        fetch('updated_pairs.json')
            .then(response => response.json())
            .then(data => {
                pairs = data;
                initialize();
            })
            .catch(error => console.error('Error loading pairs:', error));

        function initialize() {
            const allDestinations = [...new Set(Object.values(pairs).flat())];

            const today = new Date();
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };

            const dateOptions = [
                { value: 'today', label: formatDate(today) },
                { value: 'tomorrow', label: formatDate(new Date(today.getTime() + 86400000)) },
                { value: 'day-after-tomorrow', label: formatDate(new Date(today.getTime() + 2 * 86400000)) },
                { value: 'two-days-after-tomorrow', label: formatDate(new Date(today.getTime() + 3 * 86400000)) }
            ];

            const dynamicContent = document.getElementById('dynamic-content');
            const connectionRadios = document.getElementsByName('connection');
            const datesSelect = document.getElementById('dates');
            const selectAllDatesButton = document.getElementById('select-all-dates');
            const datesCheckboxes = document.getElementById('dates-checkboxes');

            function renderDateCheckboxes() {
                datesCheckboxes.innerHTML = '';
                const today = new Date();
                for (let i = 0; i < 4; i++) {
                    const date = new Date(today.getTime() + i * 86400000);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const dateStr = `${day}/${month}/${year}`;
                    const label = document.createElement('label');
                    label.style.fontWeight = 'normal';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'dates';
                    checkbox.value = dateStr;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + dateStr));
                    datesCheckboxes.appendChild(label);
                    datesCheckboxes.appendChild(document.createElement('br'));
                }
            }

            renderDateCheckboxes();

            document.getElementById('select-all-dates').onclick = function () {
                datesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            };

            connectionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    dynamicContent.innerHTML = '';

                    // --- WITH mode ---
                    if (radio.value === 'with') {
                        const fromLabel = document.createElement('label');
                        fromLabel.textContent = 'FROM';
                        fromLabel.style.display = 'block';
                        fromLabel.style.fontWeight = 'bold';
                        const originSelect = createComboBox(Object.keys(pairs), 'origin');
                        fromLabel.appendChild(originSelect);

                        const toLabel = document.createElement('label');
                        toLabel.textContent = 'TO';
                        toLabel.style.display = 'block';
                        toLabel.style.fontWeight = 'bold';
                        const destinationSelect = createComboBox(allDestinations, 'destination');
                        toLabel.appendChild(destinationSelect);

                        dynamicContent.appendChild(fromLabel);
                        dynamicContent.appendChild(toLabel);

                        datesSelect.multiple = false;
                        document.getElementById('select-all-dates').style.display = 'none';
                    } else {
                        renderRowsContainer();
                        datesSelect && (datesSelect.multiple = true);
                        document.getElementById('select-all-dates').style.display = 'inline-block';
                    }
                });
            });

            function createComboBox(options, name, onChangeCallback, isMultiSelect = false) {
                if (isMultiSelect) {
                    // MULTIPLE select as before
                    const select = document.createElement('select');
                    select.name = name;
                    select.multiple = true;
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                    if (onChangeCallback) {
                        select.addEventListener('change', onChangeCallback);
                    }
                    const selectAllButton = document.createElement('button');
                    selectAllButton.type = 'button';
                    selectAllButton.textContent = 'Select All';
                    selectAllButton.addEventListener('click', () => {
                        for (const option of select.options) {
                            option.selected = true;
                        }
                    });
                    const container = document.createElement('div');
                    container.appendChild(select);
                    container.appendChild(selectAllButton);
                    return container;
                } else {
                    // SINGLE select: use input + datalist
                    const input = document.createElement('input');
                    input.setAttribute('list', `datalist-${name}`);
                    input.name = name;
                    input.autocomplete = 'off';
                    const datalist = document.createElement('datalist');
                    datalist.id = `datalist-${name}`;
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        datalist.appendChild(opt);
                    });
                    if (onChangeCallback) {
                        input.addEventListener('change', onChangeCallback);
                    }
                    const container = document.createElement('span');
                    container.appendChild(input);
                    container.appendChild(datalist);
                    return container;
                }
            }

            function createNoneRow() {
                const row = document.createElement('div');
                row.classList.add('row');

                const fromAnywhereCheckbox = document.createElement('input');
                fromAnywhereCheckbox.type = 'checkbox';
                fromAnywhereCheckbox.name = 'from-anywhere';

                const fromAnywhereLabel = document.createElement('label');
                fromAnywhereLabel.textContent = 'From Anywhere';
                fromAnywhereLabel.appendChild(fromAnywhereCheckbox);

                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.textContent = '—';
                removeButton.className = 'remove-row-btn';
                removeButton.title = 'Remove Row';
                removeButton.addEventListener('click', () => {
                    row.remove();
                });

                const originSelect = createComboBox(Object.keys(pairs), 'origin', () => {
                    // Handle both input+datalist and multiselect
                    let selectedOrigin = null;
                    // If originSelect is input+datalist
                    if (originSelect.querySelector('input[name="origin"]')) {
                        selectedOrigin = originSelect.querySelector('input[name="origin"]').value;
                    } else if (originSelect.value !== undefined) {
                        selectedOrigin = originSelect.value;
                    }
                    const destinationOptions = pairs[selectedOrigin] || [];
                    // Find the destination select (could be inside a label)
                    let destinationSelect = row.querySelector('select[name="destination"]');
                    if (!destinationSelect) {
                        // If not found directly, search inside labels
                        const toLabel = Array.from(row.querySelectorAll('label')).find(l => l.textContent.startsWith('TO'));
                        if (toLabel) destinationSelect = toLabel.querySelector('select[name="destination"]');
                    }
                    if (destinationSelect) {
                        destinationSelect.innerHTML = '';
                        destinationOptions.forEach(dest => {
                            const opt = document.createElement('option');
                            opt.value = dest;
                            opt.textContent = dest;
                            destinationSelect.appendChild(opt);
                        });
                    }
                });

                const destinationSelect = createComboBox([], 'destination', null, true);

                // When row is rendered, also trigger the originSelect change to fill destination
                function renderRowContent() {
                    row.innerHTML = '';
                    row.appendChild(removeButton);
                    row.appendChild(fromAnywhereLabel);
                    if (fromAnywhereCheckbox.checked) {
                        // Only TO
                        const toLabel = document.createElement('label');
                        toLabel.textContent = 'TO';
                        toLabel.style.display = 'block';
                        toLabel.style.fontWeight = 'bold';
                        const anywhereSelect = createComboBox(allDestinations, 'anywhere', null, false);
                        toLabel.appendChild(anywhereSelect);
                        row.appendChild(toLabel);
                    } else {
                        // Always show FROM and TO when not 'from anywhere'
                        const fromLabel = document.createElement('label');
                        fromLabel.textContent = 'FROM';
                        fromLabel.style.display = 'block';
                        fromLabel.style.fontWeight = 'bold';
                        fromLabel.appendChild(originSelect);
                        row.appendChild(fromLabel);
                        const toLabel = document.createElement('label');
                        toLabel.textContent = 'TO';
                        toLabel.style.display = 'block';
                        toLabel.style.fontWeight = 'bold';
                        toLabel.appendChild(destinationSelect);
                        row.appendChild(toLabel);
                        // Fill destination options according to current origin
                        if (typeof originSelect.onchange === 'function') originSelect.onchange();
                        else originSelect.dispatchEvent(new Event('change'));
                    }
                }

                fromAnywhereCheckbox.addEventListener('change', renderRowContent);
                renderRowContent();

                return row;
            }

            function renderRowsContainer() {
                dynamicContent.innerHTML = '';
                const rowsContainer = document.createElement('div');
                rowsContainer.id = 'rows-container';
                dynamicContent.appendChild(rowsContainer);

                // Add initial row if none exist
                if (rowsContainer.children.length === 0) {
                    rowsContainer.appendChild(createNoneRow());
                }

                const addRowContainer = document.createElement('div');
                addRowContainer.id = 'add-row-container';
                const addButton = document.createElement('button');
                addButton.type = 'button';
                addButton.textContent = '+ Add Route';
                addButton.title = 'Add Row';
                addButton.addEventListener('click', () => {
                    rowsContainer.appendChild(createNoneRow());
                });
                addRowContainer.appendChild(addButton);
                dynamicContent.appendChild(addRowContainer);
            }

            // Update the logic for adding rows so the plus button is always below all rows
            connectionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    dynamicContent.innerHTML = '';

                    // --- WITH mode ---
                    if (radio.value === 'with') {
                        const fromLabel = document.createElement('label');
                        fromLabel.textContent = 'FROM';
                        fromLabel.style.display = 'block';
                        fromLabel.style.fontWeight = 'bold';
                        const originSelect = createComboBox(Object.keys(pairs), 'origin');
                        fromLabel.appendChild(originSelect);

                        const toLabel = document.createElement('label');
                        toLabel.textContent = 'TO';
                        toLabel.style.display = 'block';
                        toLabel.style.fontWeight = 'bold';
                        const destinationSelect = createComboBox(allDestinations, 'destination');
                        toLabel.appendChild(destinationSelect);

                        dynamicContent.appendChild(fromLabel);
                        dynamicContent.appendChild(toLabel);

                        datesSelect.multiple = false;
                        document.getElementById('select-all-dates').style.display = 'none';
                    } else {
                        renderRowsContainer();
                        datesSelect && (datesSelect.multiple = true);
                        document.getElementById('select-all-dates').style.display = 'inline-block';
                    }
                });
            });

            // Update the default state for 'none' mode on page load
            const radioNone = document.querySelector('input[type="radio"][name="connection"][value="none"]');
            if (radioNone) {
                radioNone.dispatchEvent(new Event('change'));
            }

            document.getElementById('flight-search-form').addEventListener('submit', function (e) {
                e.preventDefault();
                // Collect username and password
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                // Mode
                const mode = document.querySelector('input[type="radio"][name="connection"]:checked').value;
                // Dates
                const dateCheckboxes = document.querySelectorAll('#dates-checkboxes input[type="checkbox"]:checked');
                const dates = Array.from(dateCheckboxes).map(cb => {
                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    const [d, m, y] = cb.value.split('/');
                    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                });
                // Routes
                let routes = [];
                if (mode === 'with') {
                    const from = document.querySelector('input[name="origin"]').value;
                    const to = document.querySelector('input[name="destination"]').value;
                    routes.push([from, to]);
                } else {
                    const rows = document.querySelectorAll('.row');
                    rows.forEach(row => {
                        const fromAnywhere = row.querySelector('input[name="from-anywhere"]').checked;
                        if (fromAnywhere) {
                            const to = row.querySelector('input[name="anywhere"]').value;
                            // Find all keys in pairs where to is in the array
                            Object.entries(pairs).forEach(([from, arr]) => {
                                if (arr.includes(to)) {
                                    routes.push([from, to]);
                                }
                            });
                        } else {
                            const from = row.querySelector('input[name="origin"]')?.value;
                            if (!from) {
                                console.log('Missing origin in one of the rows');
                                return
                            }
                            const toSelect = row.querySelector('select[name="destination"]');
                            if (toSelect.multiple) {
                                Array.from(toSelect.selectedOptions).forEach(opt => {
                                    routes.push([from, opt.value]);
                                });
                            } else {
                                routes.push([from, toSelect.value]);
                            }
                        }
                    });
                }
                // Validation
                if (!username || !password || routes.length === 0 || dates.length === 0) {
                    alert('All fields are required. Please fill in all details.');
                    console.log(username, password, routes, dates, mode);
                    return;
                }
                // Build info field
                let info = '';
                if (mode === 'with') {
                    // flights_with_connections_{from}-{to}_{date1,date2,...}
                    const [from, to] = routes[0] || ['', ''];
                    info = `flights with connections from:${from} to:${to} at: ${dates.join(',')}`;
                } else {
                    const uniqueOrigins = Array.from(new Set(routes.map(r => (r[0] || '').trim().toUpperCase())));
                    let fileOrigins = uniqueOrigins.slice(0, 5).join(' ');
                    if (uniqueOrigins.length > 5) fileOrigins += ' etc';
                    info = `${fileOrigins}`;
                }
                // Build object
                const obj = {
                    username,
                    password,
                    routes,
                    dates,
                    mode,
                    info
                };
                // Remove any previous message
                let msgDiv = document.getElementById('success-message');
                if (msgDiv) msgDiv.remove();

                fetch('https://wizz-flights.onrender.com/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(obj)
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json().catch(() => ({}));
                    })
                    .then(() => {
                        const div = document.createElement('div');
                        div.id = 'success-message';
                        div.style.background = '#d4edda';
                        div.style.color = '#155724';
                        div.style.border = '1px solid #c3e6cb';
                        div.style.padding = '14px 10px';
                        div.style.borderRadius = '5px';
                        div.style.margin = '16px 0';
                        div.style.textAlign = 'center';
                        div.style.fontSize = '16px';
                        div.innerHTML = 'הבקשה התקבלה בהצלחה! התוצאות יישלחו אליך במייל.';
                        document.body.insertBefore(div, document.body.firstChild);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    })
                    .catch(() => {
                        const div = document.createElement('div');
                        div.id = 'success-message';
                        div.style.background = '#f8d7da';
                        div.style.color = '#721c24';
                        div.style.border = '1px solid #f5c6cb';
                        div.style.padding = '14px 10px';
                        div.style.borderRadius = '5px';
                        div.style.margin = '16px 0';
                        div.style.textAlign = 'center';
                        div.style.fontSize = '16px';
                        div.innerHTML = 'אירעה שגיאה בשליחת הבקשה. נסה שוב.';
                        document.body.insertBefore(div, document.body.firstChild);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
            });
        }
    </script>
</body>

</html>